bd10f2a7e23b9fcf5ffd9731ed3e8f89
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.keypressBehavior = void 0;
var _dom = require("@testing-library/dom");
var _shared = require("../shared");
var _utils = require("../../utils");

/**
 * This file should cover the behavior for keys that produce character input
 */
const keypressBehavior = [{
  matches: (keyDef, element) => {
    var _keyDef$key;
    return ((_keyDef$key = keyDef.key) == null ? void 0 : _keyDef$key.length) === 1 && (0, _utils.isElementType)(element, 'input', {
      type: 'time',
      readOnly: false
    });
  },
  handle: (keyDef, element, options, state) => {
    var _state$carryValue;
    let newEntry = keyDef.key;
    const textToBeTyped = ((_state$carryValue = state.carryValue) != null ? _state$carryValue : '') + newEntry;
    const timeNewEntry = (0, _utils.buildTimeValue)(textToBeTyped);
    if ((0, _utils.isValidInputTimeValue)(element, timeNewEntry)) {
      newEntry = timeNewEntry;
    }
    const {
      newValue,
      newSelectionStart
    } = (0, _utils.calculateNewValue)(newEntry, element);
    const prevValue = (0, _utils.getValue)(element); // this check was provided by fireInputEventIfNeeded
    // TODO: verify if it is even needed by this handler

    if (prevValue !== newValue) {
      (0, _shared.fireInputEvent)(element, {
        newValue,
        newSelectionStart,
        eventOverrides: {
          data: keyDef.key,
          inputType: 'insertText'
        }
      });
    }
    (0, _shared.fireChangeForInputTimeIfValid)(element, prevValue, timeNewEntry);
    state.carryValue = textToBeTyped;
  }
}, {
  matches: (keyDef, element) => {
    var _keyDef$key2;
    return ((_keyDef$key2 = keyDef.key) == null ? void 0 : _keyDef$key2.length) === 1 && (0, _utils.isElementType)(element, 'input', {
      type: 'date',
      readOnly: false
    });
  },
  handle: (keyDef, element, options, state) => {
    var _state$carryValue2;
    let newEntry = keyDef.key;
    const textToBeTyped = ((_state$carryValue2 = state.carryValue) != null ? _state$carryValue2 : '') + newEntry;
    const isValidToBeTyped = (0, _utils.isValidDateValue)(element, textToBeTyped);
    if (isValidToBeTyped) {
      newEntry = textToBeTyped;
    }
    const {
      newValue,
      newSelectionStart
    } = (0, _utils.calculateNewValue)(newEntry, element);
    const prevValue = (0, _utils.getValue)(element); // this check was provided by fireInputEventIfNeeded
    // TODO: verify if it is even needed by this handler

    if (prevValue !== newValue) {
      (0, _shared.fireInputEvent)(element, {
        newValue,
        newSelectionStart,
        eventOverrides: {
          data: keyDef.key,
          inputType: 'insertText'
        }
      });
    }
    if (isValidToBeTyped) {
      _dom.fireEvent.change(element, {
        target: {
          value: textToBeTyped
        }
      });
    }
    state.carryValue = textToBeTyped;
  }
}, {
  matches: (keyDef, element) => {
    var _keyDef$key3;
    return ((_keyDef$key3 = keyDef.key) == null ? void 0 : _keyDef$key3.length) === 1 && (0, _utils.isElementType)(element, 'input', {
      type: 'number',
      readOnly: false
    });
  },
  handle: (keyDef, element, options, state) => {
    var _ref, _state$carryValue3, _newValue$match, _newValue$match2;
    if (!/[\d.\-e]/.test(keyDef.key)) {
      return;
    }
    const oldValue = (_ref = (_state$carryValue3 = state.carryValue) != null ? _state$carryValue3 : (0, _utils.getValue)(element)) != null ? _ref : /* istanbul ignore next */
    '';
    const {
      newValue,
      newSelectionStart
    } = (0, _utils.calculateNewValue)(keyDef.key, element, oldValue); // the browser allows some invalid input but not others
    // it allows up to two '-' at any place before any 'e' or one directly following 'e'
    // it allows one '.' at any place before e

    const valueParts = newValue.split('e', 2);
    if (Number((_newValue$match = newValue.match(/-/g)) == null ? void 0 : _newValue$match.length) > 2 || Number((_newValue$match2 = newValue.match(/\./g)) == null ? void 0 : _newValue$match2.length) > 1 || valueParts[1] && !/^-?\d*$/.test(valueParts[1])) {
      return;
    }
    (0, _shared.fireInputEvent)(element, {
      newValue,
      newSelectionStart,
      eventOverrides: {
        data: keyDef.key,
        inputType: 'insertText'
      }
    });
    const appliedValue = (0, _utils.getValue)(element);
    if (appliedValue === newValue) {
      state.carryValue = undefined;
    } else {
      state.carryValue = newValue;
    }
  }
}, {
  matches: (keyDef, element) => {
    var _keyDef$key4;
    return ((_keyDef$key4 = keyDef.key) == null ? void 0 : _keyDef$key4.length) === 1 && ((0, _utils.isElementType)(element, ['input', 'textarea'], {
      readOnly: false
    }) && !(0, _utils.isClickableInput)(element) || (0, _utils.isContentEditable)(element)) && (0, _utils.getSpaceUntilMaxLength)(element) !== 0;
  },
  handle: (keyDef, element) => {
    const {
      newValue,
      newSelectionStart
    } = (0, _utils.calculateNewValue)(keyDef.key, element);
    (0, _shared.fireInputEvent)(element, {
      newValue,
      newSelectionStart,
      eventOverrides: {
        data: keyDef.key,
        inputType: 'insertText'
      }
    });
  }
}, {
  matches: (keyDef, element) => keyDef.key === 'Enter' && ((0, _utils.isElementType)(element, 'textarea', {
    readOnly: false
  }) || (0, _utils.isContentEditable)(element)) && (0, _utils.getSpaceUntilMaxLength)(element) !== 0,
  handle: (keyDef, element, options, state) => {
    const {
      newValue,
      newSelectionStart
    } = (0, _utils.calculateNewValue)('\n', element);
    const inputType = (0, _utils.isContentEditable)(element) && !state.modifiers.shift ? 'insertParagraph' : 'insertLineBreak';
    (0, _shared.fireInputEvent)(element, {
      newValue,
      newSelectionStart,
      eventOverrides: {
        inputType
      }
    });
  }
}];
exports.keypressBehavior = keypressBehavior;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImtleXByZXNzQmVoYXZpb3IiLCJfZG9tIiwicmVxdWlyZSIsIl9zaGFyZWQiLCJfdXRpbHMiLCJtYXRjaGVzIiwia2V5RGVmIiwiZWxlbWVudCIsIl9rZXlEZWYka2V5Iiwia2V5IiwibGVuZ3RoIiwiaXNFbGVtZW50VHlwZSIsInR5cGUiLCJyZWFkT25seSIsImhhbmRsZSIsIm9wdGlvbnMiLCJzdGF0ZSIsIl9zdGF0ZSRjYXJyeVZhbHVlIiwibmV3RW50cnkiLCJ0ZXh0VG9CZVR5cGVkIiwiY2FycnlWYWx1ZSIsInRpbWVOZXdFbnRyeSIsImJ1aWxkVGltZVZhbHVlIiwiaXNWYWxpZElucHV0VGltZVZhbHVlIiwibmV3VmFsdWUiLCJuZXdTZWxlY3Rpb25TdGFydCIsImNhbGN1bGF0ZU5ld1ZhbHVlIiwicHJldlZhbHVlIiwiZ2V0VmFsdWUiLCJmaXJlSW5wdXRFdmVudCIsImV2ZW50T3ZlcnJpZGVzIiwiZGF0YSIsImlucHV0VHlwZSIsImZpcmVDaGFuZ2VGb3JJbnB1dFRpbWVJZlZhbGlkIiwiX2tleURlZiRrZXkyIiwiX3N0YXRlJGNhcnJ5VmFsdWUyIiwiaXNWYWxpZFRvQmVUeXBlZCIsImlzVmFsaWREYXRlVmFsdWUiLCJmaXJlRXZlbnQiLCJjaGFuZ2UiLCJ0YXJnZXQiLCJfa2V5RGVmJGtleTMiLCJfcmVmIiwiX3N0YXRlJGNhcnJ5VmFsdWUzIiwiX25ld1ZhbHVlJG1hdGNoIiwiX25ld1ZhbHVlJG1hdGNoMiIsInRlc3QiLCJvbGRWYWx1ZSIsInZhbHVlUGFydHMiLCJzcGxpdCIsIk51bWJlciIsIm1hdGNoIiwiYXBwbGllZFZhbHVlIiwidW5kZWZpbmVkIiwiX2tleURlZiRrZXk0IiwiaXNDbGlja2FibGVJbnB1dCIsImlzQ29udGVudEVkaXRhYmxlIiwiZ2V0U3BhY2VVbnRpbE1heExlbmd0aCIsIm1vZGlmaWVycyIsInNoaWZ0Il0sInNvdXJjZXMiOlsiY2hhcmFjdGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5rZXlwcmVzc0JlaGF2aW9yID0gdm9pZCAwO1xuXG52YXIgX2RvbSA9IHJlcXVpcmUoXCJAdGVzdGluZy1saWJyYXJ5L2RvbVwiKTtcblxudmFyIF9zaGFyZWQgPSByZXF1aXJlKFwiLi4vc2hhcmVkXCIpO1xuXG52YXIgX3V0aWxzID0gcmVxdWlyZShcIi4uLy4uL3V0aWxzXCIpO1xuXG4vKipcbiAqIFRoaXMgZmlsZSBzaG91bGQgY292ZXIgdGhlIGJlaGF2aW9yIGZvciBrZXlzIHRoYXQgcHJvZHVjZSBjaGFyYWN0ZXIgaW5wdXRcbiAqL1xuY29uc3Qga2V5cHJlc3NCZWhhdmlvciA9IFt7XG4gIG1hdGNoZXM6IChrZXlEZWYsIGVsZW1lbnQpID0+IHtcbiAgICB2YXIgX2tleURlZiRrZXk7XG5cbiAgICByZXR1cm4gKChfa2V5RGVmJGtleSA9IGtleURlZi5rZXkpID09IG51bGwgPyB2b2lkIDAgOiBfa2V5RGVmJGtleS5sZW5ndGgpID09PSAxICYmICgwLCBfdXRpbHMuaXNFbGVtZW50VHlwZSkoZWxlbWVudCwgJ2lucHV0Jywge1xuICAgICAgdHlwZTogJ3RpbWUnLFxuICAgICAgcmVhZE9ubHk6IGZhbHNlXG4gICAgfSk7XG4gIH0sXG4gIGhhbmRsZTogKGtleURlZiwgZWxlbWVudCwgb3B0aW9ucywgc3RhdGUpID0+IHtcbiAgICB2YXIgX3N0YXRlJGNhcnJ5VmFsdWU7XG5cbiAgICBsZXQgbmV3RW50cnkgPSBrZXlEZWYua2V5O1xuICAgIGNvbnN0IHRleHRUb0JlVHlwZWQgPSAoKF9zdGF0ZSRjYXJyeVZhbHVlID0gc3RhdGUuY2FycnlWYWx1ZSkgIT0gbnVsbCA/IF9zdGF0ZSRjYXJyeVZhbHVlIDogJycpICsgbmV3RW50cnk7XG4gICAgY29uc3QgdGltZU5ld0VudHJ5ID0gKDAsIF91dGlscy5idWlsZFRpbWVWYWx1ZSkodGV4dFRvQmVUeXBlZCk7XG5cbiAgICBpZiAoKDAsIF91dGlscy5pc1ZhbGlkSW5wdXRUaW1lVmFsdWUpKGVsZW1lbnQsIHRpbWVOZXdFbnRyeSkpIHtcbiAgICAgIG5ld0VudHJ5ID0gdGltZU5ld0VudHJ5O1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIG5ld1ZhbHVlLFxuICAgICAgbmV3U2VsZWN0aW9uU3RhcnRcbiAgICB9ID0gKDAsIF91dGlscy5jYWxjdWxhdGVOZXdWYWx1ZSkobmV3RW50cnksIGVsZW1lbnQpO1xuICAgIGNvbnN0IHByZXZWYWx1ZSA9ICgwLCBfdXRpbHMuZ2V0VmFsdWUpKGVsZW1lbnQpOyAvLyB0aGlzIGNoZWNrIHdhcyBwcm92aWRlZCBieSBmaXJlSW5wdXRFdmVudElmTmVlZGVkXG4gICAgLy8gVE9ETzogdmVyaWZ5IGlmIGl0IGlzIGV2ZW4gbmVlZGVkIGJ5IHRoaXMgaGFuZGxlclxuXG4gICAgaWYgKHByZXZWYWx1ZSAhPT0gbmV3VmFsdWUpIHtcbiAgICAgICgwLCBfc2hhcmVkLmZpcmVJbnB1dEV2ZW50KShlbGVtZW50LCB7XG4gICAgICAgIG5ld1ZhbHVlLFxuICAgICAgICBuZXdTZWxlY3Rpb25TdGFydCxcbiAgICAgICAgZXZlbnRPdmVycmlkZXM6IHtcbiAgICAgICAgICBkYXRhOiBrZXlEZWYua2V5LFxuICAgICAgICAgIGlucHV0VHlwZTogJ2luc2VydFRleHQnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgICgwLCBfc2hhcmVkLmZpcmVDaGFuZ2VGb3JJbnB1dFRpbWVJZlZhbGlkKShlbGVtZW50LCBwcmV2VmFsdWUsIHRpbWVOZXdFbnRyeSk7XG4gICAgc3RhdGUuY2FycnlWYWx1ZSA9IHRleHRUb0JlVHlwZWQ7XG4gIH1cbn0sIHtcbiAgbWF0Y2hlczogKGtleURlZiwgZWxlbWVudCkgPT4ge1xuICAgIHZhciBfa2V5RGVmJGtleTI7XG5cbiAgICByZXR1cm4gKChfa2V5RGVmJGtleTIgPSBrZXlEZWYua2V5KSA9PSBudWxsID8gdm9pZCAwIDogX2tleURlZiRrZXkyLmxlbmd0aCkgPT09IDEgJiYgKDAsIF91dGlscy5pc0VsZW1lbnRUeXBlKShlbGVtZW50LCAnaW5wdXQnLCB7XG4gICAgICB0eXBlOiAnZGF0ZScsXG4gICAgICByZWFkT25seTogZmFsc2VcbiAgICB9KTtcbiAgfSxcbiAgaGFuZGxlOiAoa2V5RGVmLCBlbGVtZW50LCBvcHRpb25zLCBzdGF0ZSkgPT4ge1xuICAgIHZhciBfc3RhdGUkY2FycnlWYWx1ZTI7XG5cbiAgICBsZXQgbmV3RW50cnkgPSBrZXlEZWYua2V5O1xuICAgIGNvbnN0IHRleHRUb0JlVHlwZWQgPSAoKF9zdGF0ZSRjYXJyeVZhbHVlMiA9IHN0YXRlLmNhcnJ5VmFsdWUpICE9IG51bGwgPyBfc3RhdGUkY2FycnlWYWx1ZTIgOiAnJykgKyBuZXdFbnRyeTtcbiAgICBjb25zdCBpc1ZhbGlkVG9CZVR5cGVkID0gKDAsIF91dGlscy5pc1ZhbGlkRGF0ZVZhbHVlKShlbGVtZW50LCB0ZXh0VG9CZVR5cGVkKTtcblxuICAgIGlmIChpc1ZhbGlkVG9CZVR5cGVkKSB7XG4gICAgICBuZXdFbnRyeSA9IHRleHRUb0JlVHlwZWQ7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgbmV3VmFsdWUsXG4gICAgICBuZXdTZWxlY3Rpb25TdGFydFxuICAgIH0gPSAoMCwgX3V0aWxzLmNhbGN1bGF0ZU5ld1ZhbHVlKShuZXdFbnRyeSwgZWxlbWVudCk7XG4gICAgY29uc3QgcHJldlZhbHVlID0gKDAsIF91dGlscy5nZXRWYWx1ZSkoZWxlbWVudCk7IC8vIHRoaXMgY2hlY2sgd2FzIHByb3ZpZGVkIGJ5IGZpcmVJbnB1dEV2ZW50SWZOZWVkZWRcbiAgICAvLyBUT0RPOiB2ZXJpZnkgaWYgaXQgaXMgZXZlbiBuZWVkZWQgYnkgdGhpcyBoYW5kbGVyXG5cbiAgICBpZiAocHJldlZhbHVlICE9PSBuZXdWYWx1ZSkge1xuICAgICAgKDAsIF9zaGFyZWQuZmlyZUlucHV0RXZlbnQpKGVsZW1lbnQsIHtcbiAgICAgICAgbmV3VmFsdWUsXG4gICAgICAgIG5ld1NlbGVjdGlvblN0YXJ0LFxuICAgICAgICBldmVudE92ZXJyaWRlczoge1xuICAgICAgICAgIGRhdGE6IGtleURlZi5rZXksXG4gICAgICAgICAgaW5wdXRUeXBlOiAnaW5zZXJ0VGV4dCdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGlzVmFsaWRUb0JlVHlwZWQpIHtcbiAgICAgIF9kb20uZmlyZUV2ZW50LmNoYW5nZShlbGVtZW50LCB7XG4gICAgICAgIHRhcmdldDoge1xuICAgICAgICAgIHZhbHVlOiB0ZXh0VG9CZVR5cGVkXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRlLmNhcnJ5VmFsdWUgPSB0ZXh0VG9CZVR5cGVkO1xuICB9XG59LCB7XG4gIG1hdGNoZXM6IChrZXlEZWYsIGVsZW1lbnQpID0+IHtcbiAgICB2YXIgX2tleURlZiRrZXkzO1xuXG4gICAgcmV0dXJuICgoX2tleURlZiRrZXkzID0ga2V5RGVmLmtleSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9rZXlEZWYka2V5My5sZW5ndGgpID09PSAxICYmICgwLCBfdXRpbHMuaXNFbGVtZW50VHlwZSkoZWxlbWVudCwgJ2lucHV0Jywge1xuICAgICAgdHlwZTogJ251bWJlcicsXG4gICAgICByZWFkT25seTogZmFsc2VcbiAgICB9KTtcbiAgfSxcbiAgaGFuZGxlOiAoa2V5RGVmLCBlbGVtZW50LCBvcHRpb25zLCBzdGF0ZSkgPT4ge1xuICAgIHZhciBfcmVmLCBfc3RhdGUkY2FycnlWYWx1ZTMsIF9uZXdWYWx1ZSRtYXRjaCwgX25ld1ZhbHVlJG1hdGNoMjtcblxuICAgIGlmICghL1tcXGQuXFwtZV0vLnRlc3Qoa2V5RGVmLmtleSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBvbGRWYWx1ZSA9IChfcmVmID0gKF9zdGF0ZSRjYXJyeVZhbHVlMyA9IHN0YXRlLmNhcnJ5VmFsdWUpICE9IG51bGwgPyBfc3RhdGUkY2FycnlWYWx1ZTMgOiAoMCwgX3V0aWxzLmdldFZhbHVlKShlbGVtZW50KSkgIT0gbnVsbCA/IF9yZWYgOlxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgJyc7XG4gICAgY29uc3Qge1xuICAgICAgbmV3VmFsdWUsXG4gICAgICBuZXdTZWxlY3Rpb25TdGFydFxuICAgIH0gPSAoMCwgX3V0aWxzLmNhbGN1bGF0ZU5ld1ZhbHVlKShrZXlEZWYua2V5LCBlbGVtZW50LCBvbGRWYWx1ZSk7IC8vIHRoZSBicm93c2VyIGFsbG93cyBzb21lIGludmFsaWQgaW5wdXQgYnV0IG5vdCBvdGhlcnNcbiAgICAvLyBpdCBhbGxvd3MgdXAgdG8gdHdvICctJyBhdCBhbnkgcGxhY2UgYmVmb3JlIGFueSAnZScgb3Igb25lIGRpcmVjdGx5IGZvbGxvd2luZyAnZSdcbiAgICAvLyBpdCBhbGxvd3Mgb25lICcuJyBhdCBhbnkgcGxhY2UgYmVmb3JlIGVcblxuICAgIGNvbnN0IHZhbHVlUGFydHMgPSBuZXdWYWx1ZS5zcGxpdCgnZScsIDIpO1xuXG4gICAgaWYgKE51bWJlcigoX25ld1ZhbHVlJG1hdGNoID0gbmV3VmFsdWUubWF0Y2goLy0vZykpID09IG51bGwgPyB2b2lkIDAgOiBfbmV3VmFsdWUkbWF0Y2gubGVuZ3RoKSA+IDIgfHwgTnVtYmVyKChfbmV3VmFsdWUkbWF0Y2gyID0gbmV3VmFsdWUubWF0Y2goL1xcLi9nKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9uZXdWYWx1ZSRtYXRjaDIubGVuZ3RoKSA+IDEgfHwgdmFsdWVQYXJ0c1sxXSAmJiAhL14tP1xcZCokLy50ZXN0KHZhbHVlUGFydHNbMV0pKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgKDAsIF9zaGFyZWQuZmlyZUlucHV0RXZlbnQpKGVsZW1lbnQsIHtcbiAgICAgIG5ld1ZhbHVlLFxuICAgICAgbmV3U2VsZWN0aW9uU3RhcnQsXG4gICAgICBldmVudE92ZXJyaWRlczoge1xuICAgICAgICBkYXRhOiBrZXlEZWYua2V5LFxuICAgICAgICBpbnB1dFR5cGU6ICdpbnNlcnRUZXh0J1xuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IGFwcGxpZWRWYWx1ZSA9ICgwLCBfdXRpbHMuZ2V0VmFsdWUpKGVsZW1lbnQpO1xuXG4gICAgaWYgKGFwcGxpZWRWYWx1ZSA9PT0gbmV3VmFsdWUpIHtcbiAgICAgIHN0YXRlLmNhcnJ5VmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXRlLmNhcnJ5VmFsdWUgPSBuZXdWYWx1ZTtcbiAgICB9XG4gIH1cbn0sIHtcbiAgbWF0Y2hlczogKGtleURlZiwgZWxlbWVudCkgPT4ge1xuICAgIHZhciBfa2V5RGVmJGtleTQ7XG5cbiAgICByZXR1cm4gKChfa2V5RGVmJGtleTQgPSBrZXlEZWYua2V5KSA9PSBudWxsID8gdm9pZCAwIDogX2tleURlZiRrZXk0Lmxlbmd0aCkgPT09IDEgJiYgKCgwLCBfdXRpbHMuaXNFbGVtZW50VHlwZSkoZWxlbWVudCwgWydpbnB1dCcsICd0ZXh0YXJlYSddLCB7XG4gICAgICByZWFkT25seTogZmFsc2VcbiAgICB9KSAmJiAhKDAsIF91dGlscy5pc0NsaWNrYWJsZUlucHV0KShlbGVtZW50KSB8fCAoMCwgX3V0aWxzLmlzQ29udGVudEVkaXRhYmxlKShlbGVtZW50KSkgJiYgKDAsIF91dGlscy5nZXRTcGFjZVVudGlsTWF4TGVuZ3RoKShlbGVtZW50KSAhPT0gMDtcbiAgfSxcbiAgaGFuZGxlOiAoa2V5RGVmLCBlbGVtZW50KSA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgbmV3VmFsdWUsXG4gICAgICBuZXdTZWxlY3Rpb25TdGFydFxuICAgIH0gPSAoMCwgX3V0aWxzLmNhbGN1bGF0ZU5ld1ZhbHVlKShrZXlEZWYua2V5LCBlbGVtZW50KTtcbiAgICAoMCwgX3NoYXJlZC5maXJlSW5wdXRFdmVudCkoZWxlbWVudCwge1xuICAgICAgbmV3VmFsdWUsXG4gICAgICBuZXdTZWxlY3Rpb25TdGFydCxcbiAgICAgIGV2ZW50T3ZlcnJpZGVzOiB7XG4gICAgICAgIGRhdGE6IGtleURlZi5rZXksXG4gICAgICAgIGlucHV0VHlwZTogJ2luc2VydFRleHQnXG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn0sIHtcbiAgbWF0Y2hlczogKGtleURlZiwgZWxlbWVudCkgPT4ga2V5RGVmLmtleSA9PT0gJ0VudGVyJyAmJiAoKDAsIF91dGlscy5pc0VsZW1lbnRUeXBlKShlbGVtZW50LCAndGV4dGFyZWEnLCB7XG4gICAgcmVhZE9ubHk6IGZhbHNlXG4gIH0pIHx8ICgwLCBfdXRpbHMuaXNDb250ZW50RWRpdGFibGUpKGVsZW1lbnQpKSAmJiAoMCwgX3V0aWxzLmdldFNwYWNlVW50aWxNYXhMZW5ndGgpKGVsZW1lbnQpICE9PSAwLFxuICBoYW5kbGU6IChrZXlEZWYsIGVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlKSA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgbmV3VmFsdWUsXG4gICAgICBuZXdTZWxlY3Rpb25TdGFydFxuICAgIH0gPSAoMCwgX3V0aWxzLmNhbGN1bGF0ZU5ld1ZhbHVlKSgnXFxuJywgZWxlbWVudCk7XG4gICAgY29uc3QgaW5wdXRUeXBlID0gKDAsIF91dGlscy5pc0NvbnRlbnRFZGl0YWJsZSkoZWxlbWVudCkgJiYgIXN0YXRlLm1vZGlmaWVycy5zaGlmdCA/ICdpbnNlcnRQYXJhZ3JhcGgnIDogJ2luc2VydExpbmVCcmVhayc7XG4gICAgKDAsIF9zaGFyZWQuZmlyZUlucHV0RXZlbnQpKGVsZW1lbnQsIHtcbiAgICAgIG5ld1ZhbHVlLFxuICAgICAgbmV3U2VsZWN0aW9uU3RhcnQsXG4gICAgICBldmVudE92ZXJyaWRlczoge1xuICAgICAgICBpbnB1dFR5cGVcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufV07XG5leHBvcnRzLmtleXByZXNzQmVoYXZpb3IgPSBrZXlwcmVzc0JlaGF2aW9yOyJdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWTs7QUFFWkEsTUFBTSxDQUFDQyxjQUFjLENBQUND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
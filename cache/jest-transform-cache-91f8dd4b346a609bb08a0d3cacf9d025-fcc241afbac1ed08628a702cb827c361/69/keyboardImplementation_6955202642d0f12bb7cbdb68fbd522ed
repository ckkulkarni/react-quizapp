5e2bbadd27a02da503c5cdf4f455234b
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.keyboardImplementation = keyboardImplementation;
exports.releaseAllKeys = releaseAllKeys;
var _dom = require("@testing-library/dom");
var _utils = require("../utils");
var _getNextKeyDef = require("./getNextKeyDef");
var plugins = _interopRequireWildcard(require("./plugins"));
var _getEventProps = require("./getEventProps");
function _getRequireWildcardCache(nodeInterop) {
  if (typeof WeakMap !== "function") return null;
  var cacheBabelInterop = new WeakMap();
  var cacheNodeInterop = new WeakMap();
  return (_getRequireWildcardCache = function (nodeInterop) {
    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
  })(nodeInterop);
}
function _interopRequireWildcard(obj, nodeInterop) {
  if (!nodeInterop && obj && obj.__esModule) {
    return obj;
  }
  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }
  var cache = _getRequireWildcardCache(nodeInterop);
  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }
  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
  for (var key in obj) {
    if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }
  newObj.default = obj;
  if (cache) {
    cache.set(obj, newObj);
  }
  return newObj;
}
async function keyboardImplementation(text, options, state) {
  var _state$repeatKey;
  const {
    document
  } = options;
  const getCurrentElement = () => getActive(document);
  const {
    keyDef,
    consumedLength,
    releasePrevious,
    releaseSelf,
    repeat
  } = (_state$repeatKey = state.repeatKey) != null ? _state$repeatKey : (0, _getNextKeyDef.getNextKeyDef)(text, options);
  const replace = applyPlugins(plugins.replaceBehavior, keyDef, getCurrentElement(), options, state);
  if (!replace) {
    const pressed = state.pressed.find(p => p.keyDef === keyDef); // Release the key automatically if it was pressed before.
    // Do not release the key on iterations on `state.repeatKey`.

    if (pressed && !state.repeatKey) {
      keyup(keyDef, getCurrentElement, options, state, pressed.unpreventedDefault);
    }
    if (!releasePrevious) {
      const unpreventedDefault = keydown(keyDef, getCurrentElement, options, state);
      if (unpreventedDefault && hasKeyPress(keyDef, state)) {
        keypress(keyDef, getCurrentElement, options, state);
      } // Release the key only on the last iteration on `state.repeatKey`.

      if (releaseSelf && repeat <= 1) {
        keyup(keyDef, getCurrentElement, options, state, unpreventedDefault);
      }
    }
  }
  if (repeat > 1) {
    state.repeatKey = {
      // don't consume again on the next iteration
      consumedLength: 0,
      keyDef,
      releasePrevious,
      releaseSelf,
      repeat: repeat - 1
    };
  } else {
    delete state.repeatKey;
  }
  if (text.length > consumedLength || repeat > 1) {
    if (options.delay > 0) {
      await (0, _utils.wait)(options.delay);
    }
    return keyboardImplementation(text.slice(consumedLength), options, state);
  }
  return void undefined;
}
function getActive(document) {
  var _getActiveElement;
  return (_getActiveElement = (0, _utils.getActiveElement)(document)) != null ? _getActiveElement : /* istanbul ignore next */
  document.body;
}
function releaseAllKeys(options, state) {
  const getCurrentElement = () => getActive(options.document);
  for (const k of state.pressed) {
    keyup(k.keyDef, getCurrentElement, options, state, k.unpreventedDefault);
  }
}
function keydown(keyDef, getCurrentElement, options, state) {
  const element = getCurrentElement(); // clear carried characters when focus is moved

  if (element !== state.activeElement) {
    state.carryValue = undefined;
    state.carryChar = '';
  }
  state.activeElement = element;
  applyPlugins(plugins.preKeydownBehavior, keyDef, element, options, state);
  const unpreventedDefault = _dom.fireEvent.keyDown(element, (0, _getEventProps.getKeyEventProps)(keyDef, state));
  state.pressed.push({
    keyDef,
    unpreventedDefault
  });
  if (unpreventedDefault) {
    // all default behavior like keypress/submit etc is applied to the currentElement
    applyPlugins(plugins.keydownBehavior, keyDef, getCurrentElement(), options, state);
  }
  return unpreventedDefault;
}
function keypress(keyDef, getCurrentElement, options, state) {
  const element = getCurrentElement();
  const unpreventedDefault = _dom.fireEvent.keyPress(element, (0, _getEventProps.getKeyEventProps)(keyDef, state));
  if (unpreventedDefault) {
    applyPlugins(plugins.keypressBehavior, keyDef, getCurrentElement(), options, state);
  }
}
function keyup(keyDef, getCurrentElement, options, state, unprevented) {
  const element = getCurrentElement();
  applyPlugins(plugins.preKeyupBehavior, keyDef, element, options, state);
  const unpreventedDefault = _dom.fireEvent.keyUp(element, (0, _getEventProps.getKeyEventProps)(keyDef, state));
  if (unprevented && unpreventedDefault) {
    applyPlugins(plugins.keyupBehavior, keyDef, getCurrentElement(), options, state);
  }
  state.pressed = state.pressed.filter(k => k.keyDef !== keyDef);
  applyPlugins(plugins.postKeyupBehavior, keyDef, element, options, state);
}
function applyPlugins(pluginCollection, keyDef, element, options, state) {
  const plugin = pluginCollection.find(p => p.matches(keyDef, element, options, state));
  if (plugin) {
    plugin.handle(keyDef, element, options, state);
  }
  return !!plugin;
}
function hasKeyPress(keyDef, state) {
  var _keyDef$key;
  return (((_keyDef$key = keyDef.key) == null ? void 0 : _keyDef$key.length) === 1 || keyDef.key === 'Enter') && !state.modifiers.ctrl && !state.modifiers.alt;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImtleWJvYXJkSW1wbGVtZW50YXRpb24iLCJyZWxlYXNlQWxsS2V5cyIsIl9kb20iLCJyZXF1aXJlIiwiX3V0aWxzIiwiX2dldE5leHRLZXlEZWYiLCJwbHVnaW5zIiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJfZ2V0RXZlbnRQcm9wcyIsIl9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSIsIm5vZGVJbnRlcm9wIiwiV2Vha01hcCIsImNhY2hlQmFiZWxJbnRlcm9wIiwiY2FjaGVOb2RlSW50ZXJvcCIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiY2FjaGUiLCJoYXMiLCJnZXQiLCJuZXdPYmoiLCJoYXNQcm9wZXJ0eURlc2NyaXB0b3IiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJrZXkiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJkZXNjIiwic2V0IiwidGV4dCIsIm9wdGlvbnMiLCJzdGF0ZSIsIl9zdGF0ZSRyZXBlYXRLZXkiLCJkb2N1bWVudCIsImdldEN1cnJlbnRFbGVtZW50IiwiZ2V0QWN0aXZlIiwia2V5RGVmIiwiY29uc3VtZWRMZW5ndGgiLCJyZWxlYXNlUHJldmlvdXMiLCJyZWxlYXNlU2VsZiIsInJlcGVhdCIsInJlcGVhdEtleSIsImdldE5leHRLZXlEZWYiLCJyZXBsYWNlIiwiYXBwbHlQbHVnaW5zIiwicmVwbGFjZUJlaGF2aW9yIiwicHJlc3NlZCIsImZpbmQiLCJwIiwia2V5dXAiLCJ1bnByZXZlbnRlZERlZmF1bHQiLCJrZXlkb3duIiwiaGFzS2V5UHJlc3MiLCJrZXlwcmVzcyIsImxlbmd0aCIsImRlbGF5Iiwid2FpdCIsInNsaWNlIiwidW5kZWZpbmVkIiwiX2dldEFjdGl2ZUVsZW1lbnQiLCJnZXRBY3RpdmVFbGVtZW50IiwiYm9keSIsImsiLCJlbGVtZW50IiwiYWN0aXZlRWxlbWVudCIsImNhcnJ5VmFsdWUiLCJjYXJyeUNoYXIiLCJwcmVLZXlkb3duQmVoYXZpb3IiLCJmaXJlRXZlbnQiLCJrZXlEb3duIiwiZ2V0S2V5RXZlbnRQcm9wcyIsInB1c2giLCJrZXlkb3duQmVoYXZpb3IiLCJrZXlQcmVzcyIsImtleXByZXNzQmVoYXZpb3IiLCJ1bnByZXZlbnRlZCIsInByZUtleXVwQmVoYXZpb3IiLCJrZXlVcCIsImtleXVwQmVoYXZpb3IiLCJmaWx0ZXIiLCJwb3N0S2V5dXBCZWhhdmlvciIsInBsdWdpbkNvbGxlY3Rpb24iLCJwbHVnaW4iLCJtYXRjaGVzIiwiaGFuZGxlIiwiX2tleURlZiRrZXkiLCJtb2RpZmllcnMiLCJjdHJsIiwiYWx0Il0sInNvdXJjZXMiOlsia2V5Ym9hcmRJbXBsZW1lbnRhdGlvbi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMua2V5Ym9hcmRJbXBsZW1lbnRhdGlvbiA9IGtleWJvYXJkSW1wbGVtZW50YXRpb247XG5leHBvcnRzLnJlbGVhc2VBbGxLZXlzID0gcmVsZWFzZUFsbEtleXM7XG5cbnZhciBfZG9tID0gcmVxdWlyZShcIkB0ZXN0aW5nLWxpYnJhcnkvZG9tXCIpO1xuXG52YXIgX3V0aWxzID0gcmVxdWlyZShcIi4uL3V0aWxzXCIpO1xuXG52YXIgX2dldE5leHRLZXlEZWYgPSByZXF1aXJlKFwiLi9nZXROZXh0S2V5RGVmXCIpO1xuXG52YXIgcGx1Z2lucyA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCIuL3BsdWdpbnNcIikpO1xuXG52YXIgX2dldEV2ZW50UHJvcHMgPSByZXF1aXJlKFwiLi9nZXRFdmVudFByb3BzXCIpO1xuXG5mdW5jdGlvbiBfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUobm9kZUludGVyb3ApIHsgaWYgKHR5cGVvZiBXZWFrTWFwICE9PSBcImZ1bmN0aW9uXCIpIHJldHVybiBudWxsOyB2YXIgY2FjaGVCYWJlbEludGVyb3AgPSBuZXcgV2Vha01hcCgpOyB2YXIgY2FjaGVOb2RlSW50ZXJvcCA9IG5ldyBXZWFrTWFwKCk7IHJldHVybiAoX2dldFJlcXVpcmVXaWxkY2FyZENhY2hlID0gZnVuY3Rpb24gKG5vZGVJbnRlcm9wKSB7IHJldHVybiBub2RlSW50ZXJvcCA/IGNhY2hlTm9kZUludGVyb3AgOiBjYWNoZUJhYmVsSW50ZXJvcDsgfSkobm9kZUludGVyb3ApOyB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaiwgbm9kZUludGVyb3ApIHsgaWYgKCFub2RlSW50ZXJvcCAmJiBvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsgcmV0dXJuIG9iajsgfSBpZiAob2JqID09PSBudWxsIHx8IHR5cGVvZiBvYmogIT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIG9iaiAhPT0gXCJmdW5jdGlvblwiKSB7IHJldHVybiB7IGRlZmF1bHQ6IG9iaiB9OyB9IHZhciBjYWNoZSA9IF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZShub2RlSW50ZXJvcCk7IGlmIChjYWNoZSAmJiBjYWNoZS5oYXMob2JqKSkgeyByZXR1cm4gY2FjaGUuZ2V0KG9iaik7IH0gdmFyIG5ld09iaiA9IHt9OyB2YXIgaGFzUHJvcGVydHlEZXNjcmlwdG9yID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7IGZvciAodmFyIGtleSBpbiBvYmopIHsgaWYgKGtleSAhPT0gXCJkZWZhdWx0XCIgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IGhhc1Byb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDogbnVsbDsgaWYgKGRlc2MgJiYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgaWYgKGNhY2hlKSB7IGNhY2hlLnNldChvYmosIG5ld09iaik7IH0gcmV0dXJuIG5ld09iajsgfVxuXG5hc3luYyBmdW5jdGlvbiBrZXlib2FyZEltcGxlbWVudGF0aW9uKHRleHQsIG9wdGlvbnMsIHN0YXRlKSB7XG4gIHZhciBfc3RhdGUkcmVwZWF0S2V5O1xuXG4gIGNvbnN0IHtcbiAgICBkb2N1bWVudFxuICB9ID0gb3B0aW9ucztcblxuICBjb25zdCBnZXRDdXJyZW50RWxlbWVudCA9ICgpID0+IGdldEFjdGl2ZShkb2N1bWVudCk7XG5cbiAgY29uc3Qge1xuICAgIGtleURlZixcbiAgICBjb25zdW1lZExlbmd0aCxcbiAgICByZWxlYXNlUHJldmlvdXMsXG4gICAgcmVsZWFzZVNlbGYsXG4gICAgcmVwZWF0XG4gIH0gPSAoX3N0YXRlJHJlcGVhdEtleSA9IHN0YXRlLnJlcGVhdEtleSkgIT0gbnVsbCA/IF9zdGF0ZSRyZXBlYXRLZXkgOiAoMCwgX2dldE5leHRLZXlEZWYuZ2V0TmV4dEtleURlZikodGV4dCwgb3B0aW9ucyk7XG4gIGNvbnN0IHJlcGxhY2UgPSBhcHBseVBsdWdpbnMocGx1Z2lucy5yZXBsYWNlQmVoYXZpb3IsIGtleURlZiwgZ2V0Q3VycmVudEVsZW1lbnQoKSwgb3B0aW9ucywgc3RhdGUpO1xuXG4gIGlmICghcmVwbGFjZSkge1xuICAgIGNvbnN0IHByZXNzZWQgPSBzdGF0ZS5wcmVzc2VkLmZpbmQocCA9PiBwLmtleURlZiA9PT0ga2V5RGVmKTsgLy8gUmVsZWFzZSB0aGUga2V5IGF1dG9tYXRpY2FsbHkgaWYgaXQgd2FzIHByZXNzZWQgYmVmb3JlLlxuICAgIC8vIERvIG5vdCByZWxlYXNlIHRoZSBrZXkgb24gaXRlcmF0aW9ucyBvbiBgc3RhdGUucmVwZWF0S2V5YC5cblxuICAgIGlmIChwcmVzc2VkICYmICFzdGF0ZS5yZXBlYXRLZXkpIHtcbiAgICAgIGtleXVwKGtleURlZiwgZ2V0Q3VycmVudEVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlLCBwcmVzc2VkLnVucHJldmVudGVkRGVmYXVsdCk7XG4gICAgfVxuXG4gICAgaWYgKCFyZWxlYXNlUHJldmlvdXMpIHtcbiAgICAgIGNvbnN0IHVucHJldmVudGVkRGVmYXVsdCA9IGtleWRvd24oa2V5RGVmLCBnZXRDdXJyZW50RWxlbWVudCwgb3B0aW9ucywgc3RhdGUpO1xuXG4gICAgICBpZiAodW5wcmV2ZW50ZWREZWZhdWx0ICYmIGhhc0tleVByZXNzKGtleURlZiwgc3RhdGUpKSB7XG4gICAgICAgIGtleXByZXNzKGtleURlZiwgZ2V0Q3VycmVudEVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlKTtcbiAgICAgIH0gLy8gUmVsZWFzZSB0aGUga2V5IG9ubHkgb24gdGhlIGxhc3QgaXRlcmF0aW9uIG9uIGBzdGF0ZS5yZXBlYXRLZXlgLlxuXG5cbiAgICAgIGlmIChyZWxlYXNlU2VsZiAmJiByZXBlYXQgPD0gMSkge1xuICAgICAgICBrZXl1cChrZXlEZWYsIGdldEN1cnJlbnRFbGVtZW50LCBvcHRpb25zLCBzdGF0ZSwgdW5wcmV2ZW50ZWREZWZhdWx0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAocmVwZWF0ID4gMSkge1xuICAgIHN0YXRlLnJlcGVhdEtleSA9IHtcbiAgICAgIC8vIGRvbid0IGNvbnN1bWUgYWdhaW4gb24gdGhlIG5leHQgaXRlcmF0aW9uXG4gICAgICBjb25zdW1lZExlbmd0aDogMCxcbiAgICAgIGtleURlZixcbiAgICAgIHJlbGVhc2VQcmV2aW91cyxcbiAgICAgIHJlbGVhc2VTZWxmLFxuICAgICAgcmVwZWF0OiByZXBlYXQgLSAxXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBkZWxldGUgc3RhdGUucmVwZWF0S2V5O1xuICB9XG5cbiAgaWYgKHRleHQubGVuZ3RoID4gY29uc3VtZWRMZW5ndGggfHwgcmVwZWF0ID4gMSkge1xuICAgIGlmIChvcHRpb25zLmRlbGF5ID4gMCkge1xuICAgICAgYXdhaXQgKDAsIF91dGlscy53YWl0KShvcHRpb25zLmRlbGF5KTtcbiAgICB9XG5cbiAgICByZXR1cm4ga2V5Ym9hcmRJbXBsZW1lbnRhdGlvbih0ZXh0LnNsaWNlKGNvbnN1bWVkTGVuZ3RoKSwgb3B0aW9ucywgc3RhdGUpO1xuICB9XG5cbiAgcmV0dXJuIHZvaWQgdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBnZXRBY3RpdmUoZG9jdW1lbnQpIHtcbiAgdmFyIF9nZXRBY3RpdmVFbGVtZW50O1xuXG4gIHJldHVybiAoX2dldEFjdGl2ZUVsZW1lbnQgPSAoMCwgX3V0aWxzLmdldEFjdGl2ZUVsZW1lbnQpKGRvY3VtZW50KSkgIT0gbnVsbCA/IF9nZXRBY3RpdmVFbGVtZW50IDpcbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgZG9jdW1lbnQuYm9keTtcbn1cblxuZnVuY3Rpb24gcmVsZWFzZUFsbEtleXMob3B0aW9ucywgc3RhdGUpIHtcbiAgY29uc3QgZ2V0Q3VycmVudEVsZW1lbnQgPSAoKSA9PiBnZXRBY3RpdmUob3B0aW9ucy5kb2N1bWVudCk7XG5cbiAgZm9yIChjb25zdCBrIG9mIHN0YXRlLnByZXNzZWQpIHtcbiAgICBrZXl1cChrLmtleURlZiwgZ2V0Q3VycmVudEVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlLCBrLnVucHJldmVudGVkRGVmYXVsdCk7XG4gIH1cbn1cblxuZnVuY3Rpb24ga2V5ZG93bihrZXlEZWYsIGdldEN1cnJlbnRFbGVtZW50LCBvcHRpb25zLCBzdGF0ZSkge1xuICBjb25zdCBlbGVtZW50ID0gZ2V0Q3VycmVudEVsZW1lbnQoKTsgLy8gY2xlYXIgY2FycmllZCBjaGFyYWN0ZXJzIHdoZW4gZm9jdXMgaXMgbW92ZWRcblxuICBpZiAoZWxlbWVudCAhPT0gc3RhdGUuYWN0aXZlRWxlbWVudCkge1xuICAgIHN0YXRlLmNhcnJ5VmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgc3RhdGUuY2FycnlDaGFyID0gJyc7XG4gIH1cblxuICBzdGF0ZS5hY3RpdmVFbGVtZW50ID0gZWxlbWVudDtcbiAgYXBwbHlQbHVnaW5zKHBsdWdpbnMucHJlS2V5ZG93bkJlaGF2aW9yLCBrZXlEZWYsIGVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlKTtcblxuICBjb25zdCB1bnByZXZlbnRlZERlZmF1bHQgPSBfZG9tLmZpcmVFdmVudC5rZXlEb3duKGVsZW1lbnQsICgwLCBfZ2V0RXZlbnRQcm9wcy5nZXRLZXlFdmVudFByb3BzKShrZXlEZWYsIHN0YXRlKSk7XG5cbiAgc3RhdGUucHJlc3NlZC5wdXNoKHtcbiAgICBrZXlEZWYsXG4gICAgdW5wcmV2ZW50ZWREZWZhdWx0XG4gIH0pO1xuXG4gIGlmICh1bnByZXZlbnRlZERlZmF1bHQpIHtcbiAgICAvLyBhbGwgZGVmYXVsdCBiZWhhdmlvciBsaWtlIGtleXByZXNzL3N1Ym1pdCBldGMgaXMgYXBwbGllZCB0byB0aGUgY3VycmVudEVsZW1lbnRcbiAgICBhcHBseVBsdWdpbnMocGx1Z2lucy5rZXlkb3duQmVoYXZpb3IsIGtleURlZiwgZ2V0Q3VycmVudEVsZW1lbnQoKSwgb3B0aW9ucywgc3RhdGUpO1xuICB9XG5cbiAgcmV0dXJuIHVucHJldmVudGVkRGVmYXVsdDtcbn1cblxuZnVuY3Rpb24ga2V5cHJlc3Moa2V5RGVmLCBnZXRDdXJyZW50RWxlbWVudCwgb3B0aW9ucywgc3RhdGUpIHtcbiAgY29uc3QgZWxlbWVudCA9IGdldEN1cnJlbnRFbGVtZW50KCk7XG5cbiAgY29uc3QgdW5wcmV2ZW50ZWREZWZhdWx0ID0gX2RvbS5maXJlRXZlbnQua2V5UHJlc3MoZWxlbWVudCwgKDAsIF9nZXRFdmVudFByb3BzLmdldEtleUV2ZW50UHJvcHMpKGtleURlZiwgc3RhdGUpKTtcblxuICBpZiAodW5wcmV2ZW50ZWREZWZhdWx0KSB7XG4gICAgYXBwbHlQbHVnaW5zKHBsdWdpbnMua2V5cHJlc3NCZWhhdmlvciwga2V5RGVmLCBnZXRDdXJyZW50RWxlbWVudCgpLCBvcHRpb25zLCBzdGF0ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24ga2V5dXAoa2V5RGVmLCBnZXRDdXJyZW50RWxlbWVudCwgb3B0aW9ucywgc3RhdGUsIHVucHJldmVudGVkKSB7XG4gIGNvbnN0IGVsZW1lbnQgPSBnZXRDdXJyZW50RWxlbWVudCgpO1xuICBhcHBseVBsdWdpbnMocGx1Z2lucy5wcmVLZXl1cEJlaGF2aW9yLCBrZXlEZWYsIGVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlKTtcblxuICBjb25zdCB1bnByZXZlbnRlZERlZmF1bHQgPSBfZG9tLmZpcmVFdmVudC5rZXlVcChlbGVtZW50LCAoMCwgX2dldEV2ZW50UHJvcHMuZ2V0S2V5RXZlbnRQcm9wcykoa2V5RGVmLCBzdGF0ZSkpO1xuXG4gIGlmICh1bnByZXZlbnRlZCAmJiB1bnByZXZlbnRlZERlZmF1bHQpIHtcbiAgICBhcHBseVBsdWdpbnMocGx1Z2lucy5rZXl1cEJlaGF2aW9yLCBrZXlEZWYsIGdldEN1cnJlbnRFbGVtZW50KCksIG9wdGlvbnMsIHN0YXRlKTtcbiAgfVxuXG4gIHN0YXRlLnByZXNzZWQgPSBzdGF0ZS5wcmVzc2VkLmZpbHRlcihrID0+IGsua2V5RGVmICE9PSBrZXlEZWYpO1xuICBhcHBseVBsdWdpbnMocGx1Z2lucy5wb3N0S2V5dXBCZWhhdmlvciwga2V5RGVmLCBlbGVtZW50LCBvcHRpb25zLCBzdGF0ZSk7XG59XG5cbmZ1bmN0aW9uIGFwcGx5UGx1Z2lucyhwbHVnaW5Db2xsZWN0aW9uLCBrZXlEZWYsIGVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlKSB7XG4gIGNvbnN0IHBsdWdpbiA9IHBsdWdpbkNvbGxlY3Rpb24uZmluZChwID0+IHAubWF0Y2hlcyhrZXlEZWYsIGVsZW1lbnQsIG9wdGlvbnMsIHN0YXRlKSk7XG5cbiAgaWYgKHBsdWdpbikge1xuICAgIHBsdWdpbi5oYW5kbGUoa2V5RGVmLCBlbGVtZW50LCBvcHRpb25zLCBzdGF0ZSk7XG4gIH1cblxuICByZXR1cm4gISFwbHVnaW47XG59XG5cbmZ1bmN0aW9uIGhhc0tleVByZXNzKGtleURlZiwgc3RhdGUpIHtcbiAgdmFyIF9rZXlEZWYka2V5O1xuXG4gIHJldHVybiAoKChfa2V5RGVmJGtleSA9IGtleURlZi5rZXkpID09IG51bGwgPyB2b2lkIDAgOiBfa2V5RGVmJGtleS5sZW5ndGgpID09PSAxIHx8IGtleURlZi5rZXkgPT09ICdFbnRlcicpICYmICFzdGF0ZS5tb2RpZmllcnMuY3RybCAmJiAhc3RhdGUubW9kaWZpZXJzLmFsdDtcbn0iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBRVpBLE1BQU0sQ0FBQ0MsY0FBYyxDQUFDQyxPQUFPLEVBQUUsWUFBWSxFQUFFO0VBQzNDQyxLQUFLLEVBQUU7QUFDVCxDQUFDLENBQUM7QUFDRkQsT0FBTyxDQUFDRSxzQkFBc0IsR0FBR0Esc0JBQXNCO0FBQ3ZERixPQUFPLENBQUNHLGNBQWMsR0FBR0EsY0FBYztBQUV2QyxJQUFJQyxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQztBQUUxQyxJQUFJQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFFaEMsSUFBSUUsY0FBYyxHQUFHRixPQUFPLENBQUMsaUJBQWlCLENBQUM7QUFFL0MsSUFBSUcsT0FBTyxHQUFHQyx1QkFBdUIsQ0FBQ0osT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBRTNELElBQUlLLGNBQWMsR0FBR0wsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0FBRS9DLFNBQVNNLHdCQUF3QkEsQ0FBQ0MsV0FBVyxFQUFFO0VBQUUsSUFBSSxPQUFPQyxPQUFPLEtBQUssVUFBVSxFQUFFLE9BQU8sSUFBSTtFQUFFLElBQUlDLGlCQUFpQixHQUFHLElBQUlELE9BQU8sRUFBRTtFQUFFLElBQUlFLGdCQUFnQixHQUFHLElBQUlGLE9BQU8sRUFBRTtFQUFFLE9BQU8sQ0FBQ0Ysd0JBQXdCLEdBQUcsU0FBQUEsQ0FBVUMsV0FBVyxFQUFFO0lBQUUsT0FBT0EsV0FBVyxHQUFHRyxnQkFBZ0IsR0FBR0QsaUJBQWlCO0VBQUUsQ0FBQyxFQUFFRixXQUFXLENBQUM7QUFBRTtB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